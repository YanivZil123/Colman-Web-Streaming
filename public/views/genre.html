<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>Genres · Disney+ Demo</title>
    <link rel="stylesheet" href="/styles/style.css"/>
</head>
<body>
    <header>
        <div class="nav">
            <a href="/">← Home</a>
            <strong>Genres</strong>
        </div>
    </header>
    <main>
        <article class="container">
            <div class="row">
                <select id="genreSel">
                    <option value="">All</option>
                </select>
                <select id="sortSel">
                    <option value="popularity">Sort: Popularity</option>
                    <option value="rating">Sort: Rating</option>
                </select>
                <select id="filterSel">
                    <option value="all">All</option>
                    <option value="watched">Watched</option>
                    <option value="unwatched">Unwatched</option>
                </select>
            </div>
            <div id="grid" class="grid"></div>
        </article>
    </main>
    <footer>
        <div class="container">© 2024 Disney+ Streaming Platform</div>
    </footer>
    <script src="/scripts/api.js"></script>
    <script>
        let page=1,loading=false,done=false;
        const grid=document.getElementById('grid');
        async function load(){
            if(loading||done)return;
            loading=true;
            const params=new URLSearchParams({page,genre:genreSel.value,sort:sortSel.value,filter:filterSel.value});
            const res=await api.get('/titles?'+params.toString());
            const data=await res.json();
            if(data.items.length===0){done=true;return;}
            data.items.forEach(t=>{
                const el=document.createElement('a');
                el.href='/title.html?id='+t.id;
                el.className='card';
                el.innerHTML=`<img src="${t.posterUrl||'/images/poster-placeholder.jpg'}"><div class='p16'><div>${t.name}</div><div class='badge'>${t.year} · ${t.type}</div></div>`;
                grid.appendChild(el);
            });
            page++;
            loading=false;
        }
        ['change','click'].forEach(ev=>{
            genreSel.addEventListener(ev,()=>{grid.innerHTML='';page=1;done=false;load();});
            sortSel.addEventListener(ev,()=>{grid.innerHTML='';page=1;done=false;load();});
            filterSel.addEventListener(ev,()=>{grid.innerHTML='';page=1;done=false;load();});
        });
        const io=new IntersectionObserver(entries=>{if(entries.some(e=>e.isIntersecting)) load();});
        const sentinel=document.createElement('div');
        document.body.appendChild(sentinel);
        io.observe(sentinel);
        (async()=>{
            const g=await (await api.get('/genres')).json();
            g.items.forEach(x=>{
                const o=document.createElement('option');
                o.value=x.slug;
                o.textContent=x.name;
                genreSel.appendChild(o);
            });
            load();
        })();
    </script>
</body>
</html>
