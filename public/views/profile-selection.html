<!-- yaniv-berniker-213371776-yaniv-zilberson-214269292 -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Disney+ - Profile Selection</title>
    <meta name="description" content="Choose your Disney+ profile to continue streaming">
    <link rel="stylesheet" href="/css/style.css">
</head>
<body class="profiles-body">
    <main class="profiles-container">
        <div class="disney-logo">
            <img src="/images/logo.jpeg" alt="Disney Plus">
        </div>
        
        <h1 class="profiles-title">Who's watching?</h1>
        
        <div class="profiles-grid" id="profilesGrid">
            <!-- Sample profiles -->
            <div class="profile-card" onclick="selectProfile('Alex')">
                <div class="profile-avatar">
                    <img src="/images/avatar1.png" alt="Alex" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex'">
                    <div class="avatar-fallback">A</div>
                </div>
                <p class="profile-name">Alex</p>
            </div>
            
            <div class="profile-card" onclick="selectProfile('Emma')">
                <div class="profile-avatar">
                    <img src="/images/avatar2.png" alt="Emma" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex'">
                    <div class="avatar-fallback">E</div>
                </div>
                <p class="profile-name">Emma</p>
            </div>
            
            <div class="profile-card" onclick="selectProfile('David')">
                <div class="profile-avatar">
                    <img src="/images/avatar3.png" alt="David" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex'">
                    <div class="avatar-fallback">D</div>
                </div>
                <p class="profile-name">David</p>
            </div>
            
            <!-- Add Profile Button (shows only if less than 5 profiles) -->
            <div class="profile-card add-profile-card" onclick="showAddProfileModal()" id="addProfileCard">
                <div class="profile-avatar add-profile-avatar">
                    <span class="add-icon">+</span>
                </div>
                <p class="profile-name">Add Profile</p>
            </div>
        </div>
        
        <div class="profile-actions">
            <button class="manage-profiles-btn" onclick="toggleManageMode()">
                Manage Profiles
            </button>
        </div>
    </main>

    <!-- Add Profile Modal -->
    <div class="modal-overlay" id="addProfileModal">
        <div class="modal-content">
            <h2>Add Profile</h2>
            <form class="add-profile-form" onsubmit="addProfile(event)">
                <div class="form-group">
                    <label class="form-label" for="profileName">Your Name</label>
                    <input 
                        type="text" 
                        id="profileName" 
                        name="profileName" 
                        class="form-input" 
                        placeholder="Enter your name"
                        maxlength="20"
                    >
                </div>
                
                <div class="form-group">
                    <label class="form-label">Choose Avatar</label>
                    <div class="avatar-selection">
                        <div class="avatar-option selected" data-avatar="avatar1">
                            <img src="/images/avatar1.png" alt="Avatar 1" onload="this.style.display='block'; this.nextElementSibling.style.display='none'" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex'">
                            <div class="avatar-fallback">1</div>
                        </div>
                        <div class="avatar-option" data-avatar="avatar2">
                            <img src="/images/avatar2.png" alt="Avatar 2" onload="this.style.display='block'; this.nextElementSibling.style.display='none'" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex'">
                            <div class="avatar-fallback">2</div>
                        </div>
                        <div class="avatar-option" data-avatar="avatar3">
                            <img src="/images/avatar3.png" alt="Avatar 3" onload="this.style.display='block'; this.nextElementSibling.style.display='none'" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex'">
                            <div class="avatar-fallback">3</div>
                        </div>
                        <div class="avatar-option" data-avatar="avatar4">
                            <img src="/images/avatar4.png" alt="Avatar 4" onload="this.style.display='block'; this.nextElementSibling.style.display='none'" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex'">
                            <div class="avatar-fallback">4</div>
                        </div>
                        <div class="avatar-option" data-avatar="avatar5">
                            <img src="/images/avatar5.png" alt="Avatar 5" onload="this.style.display='block'; this.nextElementSibling.style.display='none'" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex'">
                            <div class="avatar-fallback">5</div>
                        </div>
                    </div>
                </div>
                
                <div class="modal-actions">
                    <button type="button" class="cancel-btn" onclick="closeAddProfileModal()">Cancel</button>
                    <button type="submit" class="create-btn">Create Profile</button>
                </div>
            </form>
        </div>
    </div>

    <script src="/js/api.js"></script>
    <script>
        let profiles = [];
        let manageMode = false;

        // Load profiles from API on page load
        async function loadProfilesFromAPI() {
            try {
                const response = await api.get('/profiles');
                const data = await response.json();
                profiles = (data.items || []).map(p => ({
                    id: p.id,
                    name: p.name,
                    avatarUrl: p.avatarUrl
                }));
                renderProfiles();
            } catch (error) {
                console.error('Failed to load profiles:', error);
                // Show fallback profiles if API fails
                profiles = [
                    { id: 1, name: 'Profile 1', avatarUrl: '/images/avatar1.png' },
                    { id: 2, name: 'Profile 2', avatarUrl: '/images/avatar2.png' }
                ];
                renderProfiles();
            }
        }

        function selectProfile(profileId) {
            if (manageMode) {
                // In manage mode, allow deleting
                if (confirm('Do you want to delete this profile?')) {
                    deleteProfile(profileId);
                }
                return;
            }
            
            // Normal selection - store profile and redirect to main screen
            localStorage.setItem('selectedProfileId', profileId);
            window.location.href = '/index.html';
        }

        function showAddProfileModal() {
            if (profiles.length >= 5) {
                alert('You can only have up to 5 profiles.');
                return;
            }
            document.getElementById('addProfileModal').style.display = 'flex';
            
            // Reset avatar selection to first option
            const avatarOptions = document.querySelectorAll('.avatar-option');
            avatarOptions.forEach(opt => opt.classList.remove('selected'));
            avatarOptions[0].classList.add('selected');
        }

        function closeAddProfileModal() {
            document.getElementById('addProfileModal').style.display = 'none';
            const profileNameInput = document.getElementById('profileName');
            profileNameInput.value = '';
            profileNameInput.classList.remove('error');
        }

        async function addProfile(event) {
            event.preventDefault();
            
            if (profiles.length >= 5) {
                alert('You can only have up to 5 profiles.');
                return;
            }

            const profileNameInput = document.getElementById('profileName');
            const profileName = profileNameInput.value.trim();
            const selectedAvatarElement = document.querySelector('.avatar-option.selected');
            const selectedAvatar = selectedAvatarElement.querySelector('img')?.src || '/images/avatar1.png';

            // Clear previous error styling
            profileNameInput.classList.remove('error');

            if (!profileName) {
                // Remove error class first to allow animation to restart
                profileNameInput.classList.remove('error');
                
                // Force reflow to restart animation
                void profileNameInput.offsetWidth;
                
                // Add error styling
                profileNameInput.classList.add('error');
                
                // Scroll to the input field
                profileNameInput.scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'center' 
                });
                
                // Focus and select the text
                setTimeout(() => {
                    profileNameInput.focus();
                    profileNameInput.select();
                }, 300);
                
                // Vibrate device if supported
                if (navigator.vibrate) {
                    navigator.vibrate([200, 100, 200]);
                }
                
                return;
            }

            // Check if profile name already exists
            if (profiles.some(profile => profile.name.toLowerCase() === profileName.toLowerCase())) {
                profileNameInput.classList.remove('error');
                void profileNameInput.offsetWidth;
                profileNameInput.classList.add('error');
                
                profileNameInput.scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'center' 
                });
                
                setTimeout(() => {
                    profileNameInput.focus();
                    profileNameInput.select();
                }, 300);
                
                if (navigator.vibrate) {
                    navigator.vibrate([100, 50, 100]);
                }
                
                alert('A profile with this name already exists.');
                return;
            }

            // Add new profile via API
            try {
                const response = await api.post('/profiles', {
                    name: profileName,
                    avatarUrl: selectedAvatar
                });
                const data = await response.json();
                
                // Reload profiles from API
                await loadProfilesFromAPI();
                closeAddProfileModal();
            } catch (error) {
                console.error('Failed to add profile:', error);
                alert('Failed to create profile. Please try again.');
            }
        }

        async function deleteProfile(profileId) {
            try {
                await api.delete('/profiles/' + profileId);
                await loadProfilesFromAPI();
            } catch (error) {
                console.error('Failed to delete profile:', error);
                alert('Failed to delete profile. Please try again.');
            }
        }

        function toggleManageMode() {
            manageMode = !manageMode;
            const btn = document.querySelector('.manage-profiles-btn');
            const profileCards = document.querySelectorAll('.profile-card:not(.add-profile-card)');
            
            if (manageMode) {
                btn.textContent = 'Done';
                btn.classList.add('manage-active');
                profileCards.forEach(card => card.classList.add('manage-mode'));
            } else {
                btn.textContent = 'Manage Profiles';
                btn.classList.remove('manage-active');
                profileCards.forEach(card => card.classList.remove('manage-mode'));
            }
        }

        function renderProfiles() {
            const grid = document.getElementById('profilesGrid');
            grid.innerHTML = '';

            // Render existing profiles
            profiles.forEach(profile => {
                const profileCard = document.createElement('div');
                profileCard.className = 'profile-card';
                profileCard.onclick = () => selectProfile(profile.id);
                
                const avatarUrl = profile.avatarUrl || '/images/avatar1.png';
                const initials = (profile.name || 'P').charAt(0).toUpperCase();
                
                profileCard.innerHTML = `
                    <div class="profile-avatar">
                        <img src="${avatarUrl}" alt="${profile.name}" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex'">
                        <div class="avatar-fallback">${initials}</div>
                    </div>
                    <p class="profile-name">${profile.name}</p>
                `;
                
                grid.appendChild(profileCard);
            });

            // Show add profile button if less than 5 profiles
            if (profiles.length < 5) {
                const addProfileCard = document.createElement('div');
                addProfileCard.className = 'profile-card add-profile-card';
                addProfileCard.id = 'addProfileCard';
                addProfileCard.onclick = showAddProfileModal;
                
                addProfileCard.innerHTML = `
                    <div class="profile-avatar add-profile-avatar">
                        <span class="add-icon">+</span>
                    </div>
                    <p class="profile-name">Add Profile</p>
                `;
                
                grid.appendChild(addProfileCard);
            }
        }

        // Avatar selection functionality and initialization
        document.addEventListener('DOMContentLoaded', function() {
            // Load profiles from API
            loadProfilesFromAPI();
            
            const avatarOptions = document.querySelectorAll('.avatar-option');
            
            avatarOptions.forEach(option => {
                option.addEventListener('click', function() {
                    avatarOptions.forEach(opt => opt.classList.remove('selected'));
                    this.classList.add('selected');
                });
            });

            // Clear error styling when user starts typing
            const profileNameInput = document.getElementById('profileName');
            if (profileNameInput) {
                profileNameInput.addEventListener('input', function() {
                    this.classList.remove('error');
                });
            }
        });
    </script>
</body>
</html>
