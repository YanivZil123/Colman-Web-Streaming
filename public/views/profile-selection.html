<!-- yaniv-berniker-213371776-yaniv-zilberson-214269292 -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Disney+ - Profile Selection</title>
    <meta name="description" content="Choose your Disney+ profile to continue streaming">
    <link rel="stylesheet" href="/styles/disney-plus.css">
</head>
<body class="profiles-body">
    <main class="profiles-container">
        <div class="disney-logo">
            <img src="/images/logo.jpeg" alt="Disney Plus">
        </div>
        
        <h1 class="profiles-title">Who's watching?</h1>
        
        <div class="profiles-grid" id="profilesGrid">
            <!-- Profiles will be loaded from MongoDB here -->
        </div>
        
        <div class="profile-actions">
            <button class="manage-profiles-btn" onclick="toggleManageMode()">
                Manage Profiles
            </button>
        </div>
    </main>

    <!-- Add Profile Modal -->
    <div class="modal-overlay" id="addProfileModal">
        <div class="modal-content">
            <h2>Add Profile</h2>
            <form class="add-profile-form" onsubmit="return addProfile(event)">
                <div class="form-group">
                    <label class="form-label" for="profileName">Your Name</label>
                    <input 
                        type="text" 
                        id="profileName" 
                        name="profileName" 
                        class="form-input" 
                        placeholder="Enter your name"
                        maxlength="20"
                    >
                </div>
                
                <div class="form-group">
                    <label class="form-label">Choose Avatar</label>
                    <div class="avatar-selection">
                        <div class="avatar-option selected" data-avatar="disney-character">
                            <img src="/assets/profile-avatars/disney-character.png" alt="Disney Character" onload="this.style.display='block'; this.nextElementSibling.style.display='none'" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex'">
                            <div class="avatar-fallback">D</div>
                        </div>
                        <div class="avatar-option" data-avatar="mickey-mouse">
                            <img src="/assets/profile-avatars/mickey-mouse.png" alt="Mickey Mouse" onload="this.style.display='block'; this.nextElementSibling.style.display='none'" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex'">
                            <div class="avatar-fallback">M</div>
                        </div>
                        <div class="avatar-option" data-avatar="minnie-mouse">
                            <img src="/assets/profile-avatars/minnie-mouse.png" alt="Minnie Mouse" onload="this.style.display='block'; this.nextElementSibling.style.display='none'" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex'">
                            <div class="avatar-fallback">M</div>
                        </div>
                        <div class="avatar-option" data-avatar="donald-duck">
                            <img src="/assets/profile-avatars/donald-duck.png" alt="Donald Duck" onload="this.style.display='block'; this.nextElementSibling.style.display='none'" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex'">
                            <div class="avatar-fallback">D</div>
                        </div>
                        <div class="avatar-option" data-avatar="goofy">
                            <img src="/assets/profile-avatars/goofy.png" alt="Goofy" onload="this.style.display='block'; this.nextElementSibling.style.display='none'" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex'">
                            <div class="avatar-fallback">G</div>
                        </div>
                        <div class="avatar-option" data-avatar="lion-portrait">
                            <img src="/assets/profile-avatars/lion-portrait.jpg" alt="Lion Portrait" onload="this.style.display='block'; this.nextElementSibling.style.display='none'" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex'">
                            <div class="avatar-fallback">ü¶Å</div>
                        </div>
                        <div class="avatar-option" data-avatar="formal-dog">
                            <img src="/assets/profile-avatars/formal-dog.jpg" alt="Formal Dog" onload="this.style.display='block'; this.nextElementSibling.style.display='none'" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex'">
                            <div class="avatar-fallback">üêï</div>
                        </div>
                        <div class="avatar-option" data-avatar="smoking-camel">
                            <img src="/assets/profile-avatars/smoking-camel.jpg" alt="Smoking Camel" onload="this.style.display='block'; this.nextElementSibling.style.display='none'" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex'">
                            <div class="avatar-fallback">üê´</div>
                        </div>
                        <div class="avatar-option" data-avatar="pepe-frog">
                            <img src="/assets/profile-avatars/pepe-frog.jpg" alt="Pepe Frog" onload="this.style.display='block'; this.nextElementSibling.style.display='none'" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex'">
                            <div class="avatar-fallback">üê∏</div>
                        </div>
                        <div class="avatar-option" data-avatar="tree-creature">
                            <img src="/assets/profile-avatars/tree-creature.png" alt="Tree Creature" onload="this.style.display='block'; this.nextElementSibling.style.display='none'" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex'">
                            <div class="avatar-fallback">üå≥</div>
                        </div>
                    </div>
                </div>
                
                <div class="form-buttons">
                    <button type="button" class="cancel-btn" onclick="closeAddProfileModal()">Cancel</button>
                    <button type="submit" class="submit-btn">Create Profile</button>
                </div>
            </form>
        </div>
    </div>

    <script src="/scripts/api.js"></script>
    <script>
        let profiles = [];
        let manageMode = false;

        // Load profiles from MongoDB API
        async function loadProfilesFromAPI() {
            try {
                const response = await api.get('/profiles');
                
                if (!response.ok) {
                    throw new Error('Failed to load profiles');
                }
                
                const data = await response.json();
                profiles = (data.items || []).map(p => ({
                    id: p.id,
                    name: p.name,
                    avatarUrl: p.avatarUrl
                }));
                
                renderProfiles();
            } catch (error) {
                console.error('Failed to load profiles:', error);
                alert('Failed to load profiles. Please refresh the page.');
                profiles = [];
                renderProfiles();
            }
        }

        function selectProfile(profileId) {
            if (manageMode) {
                // In manage mode, allow deleting
                if (confirm('Do you want to delete this profile?')) {
                    deleteProfile(profileId);
                }
                return;
            }
            
            // Normal selection - store profile and redirect to the standalone home view (keeps navbar and body)
            localStorage.setItem('selectedProfileId', profileId);
            window.location.href = '/views/home.html';
        }

        function showAddProfileModal() {
            if (profiles.length >= 5) {
                alert('You can only have up to 5 profiles.');
                return;
            }
            document.getElementById('addProfileModal').style.display = 'flex';
            
            // Reset avatar selection to first option
            const avatarOptions = document.querySelectorAll('.avatar-option');
            avatarOptions.forEach(opt => opt.classList.remove('selected'));
            avatarOptions[0].classList.add('selected');
        }

        function closeAddProfileModal() {
            document.getElementById('addProfileModal').style.display = 'none';
            const profileNameInput = document.getElementById('profileName');
            profileNameInput.value = '';
            profileNameInput.classList.remove('error');
        }

        async function addProfile(event) {
            event.preventDefault();
            
            if (profiles.length >= 5) {
                alert('You can only have up to 5 profiles.');
                return false;
            }

            // Get profile name
            const profileNameInput = document.getElementById('profileName');
            const profileName = profileNameInput.value.trim();
            
            // Get selected avatar data
            const selectedAvatarElement = document.querySelector('.avatar-option.selected');
            const selectedAvatar = selectedAvatarElement.dataset.avatar;
            const selectedAvatarImg = selectedAvatarElement.querySelector('img');
            const avatarUrl = selectedAvatarImg ? selectedAvatarImg.src : `/assets/profile-avatars/${selectedAvatar}.png`;

            console.log('Adding profile:', profileName, 'with avatar:', avatarUrl); // Debug log

            // Clear previous error styling
            profileNameInput.classList.remove('error');

            if (!profileName) {
                console.log('Profile name is empty'); // Debug log
                
                // Remove error class first to allow animation to restart
                profileNameInput.classList.remove('error');
                
                // Force reflow to restart animation
                void profileNameInput.offsetWidth;
                
                // Add error styling
                profileNameInput.classList.add('error');
                
                // Scroll to the input field
                profileNameInput.scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'center' 
                });
                
                // Focus and select the text
                setTimeout(() => {
                    profileNameInput.focus();
                    profileNameInput.select();
                }, 300);
                
                // Vibrate device if supported
                if (navigator.vibrate) {
                    navigator.vibrate([200, 100, 200]);
                }
                
                return false;
            }

            // Check if profile name already exists
            if (profiles.some(profile => profile.name.toLowerCase() === profileName.toLowerCase())) {
                console.log('Duplicate profile name'); // Debug log
                
                profileNameInput.classList.remove('error');
                void profileNameInput.offsetWidth;
                profileNameInput.classList.add('error');
                
                profileNameInput.scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'center' 
                });
                
                setTimeout(() => {
                    profileNameInput.focus();
                    profileNameInput.select();
                }, 300);
                
                if (navigator.vibrate) {
                    navigator.vibrate([100, 50, 100]);
                }
                
                alert('A profile with this name already exists.');
                return false;
            }

            // Create profile via MongoDB API
            try {
                const response = await api.post('/profiles', {
                    name: profileName,
                    avatarUrl: avatarUrl
                });
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    if (errorData.error === 'limit') {
                        alert('You can only have up to 5 profiles.');
                    } else {
                        throw new Error('Failed to create profile');
                    }
                    return false;
                }
                
                // Reload profiles from MongoDB
                await loadProfilesFromAPI();
                closeAddProfileModal();
            } catch (error) {
                console.error('Failed to create profile:', error);
                alert('Failed to create profile. Please try again.');
            }
            
            return false;
        }

        async function deleteProfile(profileId) {
            try {
                const response = await api.delete('/profiles/' + profileId);
                
                if (!response.ok) {
                    throw new Error('Failed to delete profile');
                }
                
                // Reload profiles from MongoDB
                await loadProfilesFromAPI();
            } catch (error) {
                console.error('Failed to delete profile:', error);
                alert('Failed to delete profile. Please try again.');
            }
        }

        function toggleManageMode() {
            manageMode = !manageMode;
            const btn = document.querySelector('.manage-profiles-btn');
            const profileCards = document.querySelectorAll('.profile-card:not(.add-profile-card)');
            const deleteButtons = document.querySelectorAll('.delete-profile-btn');
            
            if (manageMode) {
                btn.textContent = 'Done';
                btn.classList.add('manage-active');
                profileCards.forEach(card => card.classList.add('manage-mode'));
                deleteButtons.forEach(btn => btn.style.display = 'block');
            } else {
                btn.textContent = 'Manage Profiles';
                btn.classList.remove('manage-active');
                profileCards.forEach(card => card.classList.remove('manage-mode'));
                deleteButtons.forEach(btn => btn.style.display = 'none');
            }
        }

        function renderProfiles() {
            const grid = document.getElementById('profilesGrid');
            grid.innerHTML = '';

            // Render existing profiles
            profiles.forEach(profile => {
                const profileCard = document.createElement('div');
                profileCard.className = 'profile-card';
                profileCard.dataset.profileId = profile.id;
                
                const avatarUrl = profile.avatarUrl || '/images/avatar1.png';
                const initials = (profile.name || 'P').charAt(0).toUpperCase();
                
                profileCard.innerHTML = `
                    <div class="profile-avatar">
                        <img src="${avatarUrl}" alt="${profile.name}" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex'">
                        <div class="avatar-fallback">${initials}</div>
                    </div>
                    <p class="profile-name">${profile.name}</p>
                    <button class="delete-profile-btn" onclick="event.stopPropagation(); deleteProfile(${profile.id})" style="display: none;">√ó</button>
                `;
                
                // Add click handler for selection
                profileCard.addEventListener('click', () => selectProfile(profile.id));
                
                grid.appendChild(profileCard);
            });

            // Show add profile button if less than 5 profiles
            if (profiles.length < 5) {
                const addProfileCard = document.createElement('div');
                addProfileCard.className = 'profile-card add-profile-card';
                addProfileCard.id = 'addProfileCard';
                addProfileCard.onclick = showAddProfileModal;
                
                addProfileCard.innerHTML = `
                    <div class="profile-avatar add-profile-avatar">
                        <span class="add-icon">+</span>
                    </div>
                    <p class="profile-name">Add Profile</p>
                `;
                
                grid.appendChild(addProfileCard);
            }
        }

        // Avatar selection functionality and initialization
        document.addEventListener('DOMContentLoaded', function() {
            // Load profiles from API
            loadProfilesFromAPI();
            
            const avatarOptions = document.querySelectorAll('.avatar-option');
            
            avatarOptions.forEach(option => {
                option.addEventListener('click', function() {
                    avatarOptions.forEach(opt => opt.classList.remove('selected'));
                    this.classList.add('selected');
                });
            });

            // Clear error styling when user starts typing
            const profileNameInput = document.getElementById('profileName');
            if (profileNameInput) {
                profileNameInput.addEventListener('input', function() {
                    this.classList.remove('error');
                });
            }
        });
    </script>
</body>
</html>
