<!-- yaniv-berniker-213371776-yaniv-zilberson-214269292 -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Disney+ - Profile Selection</title>
    <meta name="description" content="Choose your Disney+ profile to continue streaming">
    <link rel="stylesheet" href="/styles/disney-plus.css">
    <style>
        /* Disney+ Cinematic Loading Screen - Circle Animation */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #1A1D29;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            opacity: 1;
            transition: opacity 0.6s ease;
        }

        .loading-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .loading-screen.completing {
            animation: completionFlash 0.5s ease-out;
        }

        /* Circle Container */
        .aurora-circle-container {
            position: relative;
            width: 150px;
            height: 150px;
        }

        /* Main rotating circle */
        .aurora-circle {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            border: 4px solid transparent;
            border-top-color: #00D6E8;
            border-right-color: rgba(0, 214, 232, 0.6);
            animation: circleRotate 2s cubic-bezier(0.4, 0, 0.2, 1) infinite;
            filter: drop-shadow(0 0 20px rgba(0, 214, 232, 0.8));
        }

        /* Secondary circle for depth */
        .aurora-circle-secondary {
            position: absolute;
            width: 120px;
            height: 120px;
            top: 15px;
            left: 15px;
            border-radius: 50%;
            border: 3px solid transparent;
            border-bottom-color: #00D6E8;
            border-left-color: rgba(0, 214, 232, 0.4);
            animation: circleRotateReverse 2.5s cubic-bezier(0.4, 0, 0.2, 1) infinite;
            filter: drop-shadow(0 0 15px rgba(0, 214, 232, 0.6));
        }

        /* Inner glow circle */
        .aurora-circle-inner {
            position: absolute;
            width: 90px;
            height: 90px;
            top: 30px;
            left: 30px;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(0, 214, 232, 0.2) 0%, transparent 70%);
            animation: innerPulse 2s ease-in-out infinite;
        }

        /* Shimmer particles */
        .circle-particle {
            position: absolute;
            width: 6px;
            height: 6px;
            background: #00D6E8;
            border-radius: 50%;
            box-shadow: 0 0 10px #00D6E8, 0 0 20px rgba(0, 214, 232, 0.8);
            animation: particleOrbit 2s cubic-bezier(0.4, 0, 0.2, 1) infinite;
        }

        .circle-particle:nth-child(1) {
            animation-delay: 0s;
            animation-duration: 2s;
        }

        .circle-particle:nth-child(2) {
            animation-delay: 0.4s;
            animation-duration: 2.2s;
        }

        .circle-particle:nth-child(3) {
            animation-delay: 0.8s;
            animation-duration: 2.4s;
        }

        .circle-particle:nth-child(4) {
            animation-delay: 1.2s;
            animation-duration: 2.6s;
        }

        /* Dynamic rotation: slow then fast */
        @keyframes circleRotate {
            0% {
                transform: rotate(0deg);
                animation-timing-function: ease-in;
            }
            50% {
                transform: rotate(180deg);
                animation-timing-function: ease-out;
            }
            100% {
                transform: rotate(360deg);
            }
        }

        @keyframes circleRotateReverse {
            0% {
                transform: rotate(360deg);
                animation-timing-function: ease-in;
            }
            50% {
                transform: rotate(180deg);
                animation-timing-function: ease-out;
            }
            100% {
                transform: rotate(0deg);
            }
        }

        @keyframes innerPulse {
            0%, 100% {
                transform: scale(1);
                opacity: 0.4;
            }
            50% {
                transform: scale(1.3);
                opacity: 0.8;
            }
        }

        @keyframes particleOrbit {
            0% {
                transform: rotate(0deg) translateX(75px) scale(0);
                opacity: 0;
            }
            20% {
                opacity: 1;
                transform: rotate(72deg) translateX(75px) scale(1);
            }
            80% {
                opacity: 1;
                transform: rotate(288deg) translateX(75px) scale(1);
            }
            100% {
                transform: rotate(360deg) translateX(75px) scale(0);
                opacity: 0;
            }
        }

        /* Completion animation */
        @keyframes completionFlash {
            0% {
                background: #1A1D29;
            }
            50% {
                background: rgba(0, 214, 232, 0.2);
            }
            100% {
                background: #1A1D29;
            }
        }

        .aurora-circle-container.completing .aurora-circle,
        .aurora-circle-container.completing .aurora-circle-secondary {
            animation: completeCircle 0.5s ease-out forwards;
        }

        .aurora-circle-container.completing .circle-particle {
            animation: particleExplode 0.5s ease-out forwards;
        }

        @keyframes completeCircle {
            0% {
                transform: rotate(0deg) scale(1);
                opacity: 1;
            }
            50% {
                transform: scale(1.2);
                opacity: 1;
            }
            100% {
                transform: scale(0);
                opacity: 0;
            }
        }

        @keyframes particleExplode {
            0% {
                transform: translate(0, 0) scale(1);
                opacity: 1;
            }
            100% {
                transform: translate(var(--explode-x, 100px), var(--explode-y, -100px)) scale(0);
                opacity: 0;
            }
        }

        /* Hide main content while loading */
        body.loading .profiles-container {
            opacity: 0;
        }

        body.loading .profiles-container {
            transition: opacity 0.3s ease;
        }
    </style>
</head>
<body class="profiles-body loading">
    <!-- Disney+ Cinematic Loading Screen -->
    <div class="loading-screen" id="loadingScreen">
        <div class="aurora-circle-container" id="circleContainer">
            <div class="aurora-circle"></div>
            <div class="aurora-circle-secondary"></div>
            <div class="aurora-circle-inner"></div>
            <div class="circle-particle" style="--explode-x: 150px; --explode-y: -150px;"></div>
            <div class="circle-particle" style="--explode-x: -150px; --explode-y: -150px;"></div>
            <div class="circle-particle" style="--explode-x: 150px; --explode-y: 150px;"></div>
            <div class="circle-particle" style="--explode-x: -150px; --explode-y: 150px;"></div>
        </div>
    </div>

    <main class="profiles-container">
        <header>
            <div class="disney-logo">
                <img src="/images/logo.jpeg" alt="Disney Plus">
            </div>
        </header>
        
        <article>
            <h1 class="profiles-title">Who's watching?</h1>
            
            <div class="profiles-grid" id="profilesGrid">
                <!-- Profiles will be loaded from MongoDB here -->
            </div>
            
            <div class="profile-actions">
                <button class="manage-profiles-btn" onclick="toggleManageMode()">
                    Manage Profiles
                </button>
            </div>
        </article>
    </main>

    <!-- Aside: Add Profile Modal -->
    <aside class="modal-overlay" id="addProfileModal">
        <div class="modal-content">
            <h2>Add Profile</h2>
            <form class="add-profile-form" onsubmit="return addProfile(event)">
                <div class="form-group">
                    <label class="form-label" for="profileName">Your Name</label>
                    <input 
                        type="text" 
                        id="profileName" 
                        name="profileName" 
                        class="form-input" 
                        placeholder="Enter your name"
                        maxlength="20"
                    >
                </div>
                
                <div class="form-group">
                    <label class="form-label">Choose Avatar</label>
                    <div class="avatar-selection">
                        <div class="avatar-option selected" data-avatar="disney-character">
                            <img src="/assets/profile-avatars/disney-character.png" alt="Disney Character" onload="this.style.display='block'; this.nextElementSibling.style.display='none'" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex'">
                            <div class="avatar-fallback">D</div>
                        </div>
                        <div class="avatar-option" data-avatar="mickey-mouse">
                            <img src="/assets/profile-avatars/mickey-mouse.png" alt="Mickey Mouse" onload="this.style.display='block'; this.nextElementSibling.style.display='none'" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex'">
                            <div class="avatar-fallback">M</div>
                        </div>
                        <div class="avatar-option" data-avatar="minnie-mouse">
                            <img src="/assets/profile-avatars/minnie-mouse.png" alt="Minnie Mouse" onload="this.style.display='block'; this.nextElementSibling.style.display='none'" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex'">
                            <div class="avatar-fallback">M</div>
                        </div>
                        <div class="avatar-option" data-avatar="donald-duck">
                            <img src="/assets/profile-avatars/donald-duck.png" alt="Donald Duck" onload="this.style.display='block'; this.nextElementSibling.style.display='none'" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex'">
                            <div class="avatar-fallback">D</div>
                        </div>
                        <div class="avatar-option" data-avatar="goofy">
                            <img src="/assets/profile-avatars/goofy.png" alt="Goofy" onload="this.style.display='block'; this.nextElementSibling.style.display='none'" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex'">
                            <div class="avatar-fallback">G</div>
                        </div>
                        <div class="avatar-option" data-avatar="lion-portrait">
                            <img src="/assets/profile-avatars/lion-portrait.jpg" alt="Lion Portrait" onload="this.style.display='block'; this.nextElementSibling.style.display='none'" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex'">
                            <div class="avatar-fallback">ü¶Å</div>
                        </div>
                        <div class="avatar-option" data-avatar="formal-dog">
                            <img src="/assets/profile-avatars/formal-dog.jpg" alt="Formal Dog" onload="this.style.display='block'; this.nextElementSibling.style.display='none'" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex'">
                            <div class="avatar-fallback">üêï</div>
                        </div>
                        <div class="avatar-option" data-avatar="smoking-camel">
                            <img src="/assets/profile-avatars/smoking-camel.jpg" alt="Smoking Camel" onload="this.style.display='block'; this.nextElementSibling.style.display='none'" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex'">
                            <div class="avatar-fallback">üê´</div>
                        </div>
                        <div class="avatar-option" data-avatar="pepe-frog">
                            <img src="/assets/profile-avatars/pepe-frog.jpg" alt="Pepe Frog" onload="this.style.display='block'; this.nextElementSibling.style.display='none'" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex'">
                            <div class="avatar-fallback">üê∏</div>
                        </div>
                        <div class="avatar-option" data-avatar="tree-creature">
                            <img src="/assets/profile-avatars/tree-creature.png" alt="Tree Creature" onload="this.style.display='block'; this.nextElementSibling.style.display='none'" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex'">
                            <div class="avatar-fallback">üå≥</div>
                        </div>
                    </div>
                </div>
                
                <div class="form-buttons">
                    <button type="button" class="cancel-btn" onclick="closeAddProfileModal()">Cancel</button>
                    <button type="submit" class="submit-btn">Create Profile</button>
                </div>
            </form>
        </div>
    </aside>

    <!-- Aside: Edit Profile Modal -->
    <aside class="modal-overlay" id="editProfileModal">
        <div class="modal-content">
            <h2>Edit Profile</h2>
            <form class="edit-profile-form" onsubmit="return updateProfile(event)">
                <input type="hidden" id="editProfileId">
                <div class="form-group">
                    <label class="form-label" for="editProfileName">Your Name</label>
                    <input 
                        type="text" 
                        id="editProfileName" 
                        name="editProfileName" 
                        class="form-input" 
                        placeholder="Enter your name"
                        maxlength="20"
                    >
                </div>
                
                <div class="form-group">
                    <label class="form-label">Choose Avatar</label>
                    <div class="avatar-selection" id="editAvatarSelection">
                        <div class="avatar-option" data-avatar="disney-character">
                            <img src="/assets/profile-avatars/disney-character.png" alt="Disney Character" onload="this.style.display='block'; this.nextElementSibling.style.display='none'" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex'">
                            <div class="avatar-fallback">D</div>
                        </div>
                        <div class="avatar-option" data-avatar="mickey-mouse">
                            <img src="/assets/profile-avatars/mickey-mouse.png" alt="Mickey Mouse" onload="this.style.display='block'; this.nextElementSibling.style.display='none'" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex'">
                            <div class="avatar-fallback">M</div>
                        </div>
                        <div class="avatar-option" data-avatar="minnie-mouse">
                            <img src="/assets/profile-avatars/minnie-mouse.png" alt="Minnie Mouse" onload="this.style.display='block'; this.nextElementSibling.style.display='none'" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex'">
                            <div class="avatar-fallback">M</div>
                        </div>
                        <div class="avatar-option" data-avatar="donald-duck">
                            <img src="/assets/profile-avatars/donald-duck.png" alt="Donald Duck" onload="this.style.display='block'; this.nextElementSibling.style.display='none'" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex'">
                            <div class="avatar-fallback">D</div>
                        </div>
                        <div class="avatar-option" data-avatar="goofy">
                            <img src="/assets/profile-avatars/goofy.png" alt="Goofy" onload="this.style.display='block'; this.nextElementSibling.style.display='none'" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex'">
                            <div class="avatar-fallback">G</div>
                        </div>
                        <div class="avatar-option" data-avatar="lion-portrait">
                            <img src="/assets/profile-avatars/lion-portrait.jpg" alt="Lion Portrait" onload="this.style.display='block'; this.nextElementSibling.style.display='none'" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex'">
                            <div class="avatar-fallback">ü¶Å</div>
                        </div>
                        <div class="avatar-option" data-avatar="formal-dog">
                            <img src="/assets/profile-avatars/formal-dog.jpg" alt="Formal Dog" onload="this.style.display='block'; this.nextElementSibling.style.display='none'" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex'">
                            <div class="avatar-fallback">üêï</div>
                        </div>
                        <div class="avatar-option" data-avatar="smoking-camel">
                            <img src="/assets/profile-avatars/smoking-camel.jpg" alt="Smoking Camel" onload="this.style.display='block'; this.nextElementSibling.style.display='none'" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex'">
                            <div class="avatar-fallback">üê´</div>
                        </div>
                        <div class="avatar-option" data-avatar="pepe-frog">
                            <img src="/assets/profile-avatars/pepe-frog.jpg" alt="Pepe Frog" onload="this.style.display='block'; this.nextElementSibling.style.display='none'" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex'">
                            <div class="avatar-fallback">üê∏</div>
                        </div>
                        <div class="avatar-option" data-avatar="tree-creature">
                            <img src="/assets/profile-avatars/tree-creature.png" alt="Tree Creature" onload="this.style.display='block'; this.nextElementSibling.style.display='none'" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex'">
                            <div class="avatar-fallback">üå≥</div>
                        </div>
                    </div>
                </div>
                
                <div class="form-buttons">
                    <button type="button" class="cancel-btn" onclick="closeEditProfileModal()">Cancel</button>
                    <button type="submit" class="submit-btn">Save Changes</button>
                </div>
            </form>
        </div>
    </aside>

    <!-- Footer -->
    <footer>
        <div class="footer-content">
            <div class="footer-section">
                <p>&copy; 2024 Disney+ Streaming Platform</p>
            </div>
            <nav class="footer-nav">
                <a href="/views/home.html">Home</a>
                <a href="/views/series.html">Series</a>
                <a href="/views/movies.html">Movies</a>
                <a href="/views/settings.html">Settings</a>
            </nav>
        </div>
    </footer>

    <script src="/scripts/api.js"></script>
    <script>
        let profiles = [];
        let manageMode = false;

        // Load profiles from MongoDB API
        async function loadProfilesFromAPI() {
            try {
                const response = await api.get('/api/profiles');
                
                if (!response.ok) {
                    throw new Error('Failed to load profiles');
                }
                
                const data = await response.json();
                profiles = (data.items || []).map(p => ({
                    id: p.id,
                    name: p.name,
                    avatarUrl: p.avatarUrl
                }));
                
                renderProfiles();
                hideLoadingScreen();
            } catch (error) {
                console.error('Failed to load profiles:', error);
                hideLoadingScreen();
                alert('Failed to load profiles. Please refresh the page.');
                profiles = [];
                renderProfiles();
            }
        }

        function hideLoadingScreen() {
            const loadingScreen = document.getElementById('loadingScreen');
            const circleContainer = document.getElementById('circleContainer');
            const body = document.body;
            
            if (loadingScreen && circleContainer) {
                // Trigger completion animation
                loadingScreen.classList.add('completing');
                circleContainer.classList.add('completing');
                
                // Wait for completion animation, then fade out
                setTimeout(() => {
                    loadingScreen.classList.add('hidden');
                    body.classList.remove('loading');
                    
                    // Remove loading screen from DOM after fade
                    setTimeout(() => {
                        if (loadingScreen.parentNode) {
                            loadingScreen.parentNode.removeChild(loadingScreen);
                        }
                    }, 600);
                }, 500);
            }
        }

        function selectProfile(profileId) {
            if (manageMode) {
                // In manage mode, open edit modal
                showEditProfileModal(profileId);
                return;
            }
            
            // Normal selection - store profile and redirect to the standalone home view (keeps navbar and body)
            localStorage.setItem('selectedProfileId', profileId);
            
            // Dispatch profile switch event to clear home page cache
            window.dispatchEvent(new CustomEvent('profile-switched', { 
                detail: { profileId } 
            }));
            
            window.location.href = '/views/home.html';
        }

        function showAddProfileModal() {
            if (profiles.length >= 5) {
                alert('You can only have up to 5 profiles.');
                return;
            }
            document.getElementById('addProfileModal').style.display = 'flex';
            
            // Reset avatar selection to first option
            const avatarOptions = document.querySelectorAll('.avatar-option');
            avatarOptions.forEach(opt => opt.classList.remove('selected'));
            avatarOptions[0].classList.add('selected');
        }

        function closeAddProfileModal() {
            document.getElementById('addProfileModal').style.display = 'none';
            const profileNameInput = document.getElementById('profileName');
            profileNameInput.value = '';
            profileNameInput.classList.remove('error');
        }

        async function addProfile(event) {
            event.preventDefault();
            
            if (profiles.length >= 5) {
                alert('You can only have up to 5 profiles.');
                return false;
            }

            // Get profile name
            const profileNameInput = document.getElementById('profileName');
            const profileName = profileNameInput.value.trim();
            
            // Get selected avatar data
            const selectedAvatarElement = document.querySelector('.avatar-option.selected');
            const selectedAvatar = selectedAvatarElement.dataset.avatar;
            const selectedAvatarImg = selectedAvatarElement.querySelector('img');
            const avatarUrl = selectedAvatarImg ? selectedAvatarImg.src : `/assets/profile-avatars/${selectedAvatar}.png`;

            console.log('Adding profile:', profileName, 'with avatar:', avatarUrl); // Debug log

            // Clear previous error styling
            profileNameInput.classList.remove('error');

            if (!profileName) {
                console.log('Profile name is empty'); // Debug log
                
                // Remove error class first to allow animation to restart
                profileNameInput.classList.remove('error');
                
                // Force reflow to restart animation
                void profileNameInput.offsetWidth;
                
                // Add error styling
                profileNameInput.classList.add('error');
                
                // Scroll to the input field
                profileNameInput.scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'center' 
                });
                
                // Focus and select the text
                setTimeout(() => {
                    profileNameInput.focus();
                    profileNameInput.select();
                }, 300);
                
                // Vibrate device if supported
                if (navigator.vibrate) {
                    navigator.vibrate([200, 100, 200]);
                }
                
                return false;
            }

            // Check if profile name already exists
            if (profiles.some(profile => profile.name.toLowerCase() === profileName.toLowerCase())) {
                console.log('Duplicate profile name'); // Debug log
                
                profileNameInput.classList.remove('error');
                void profileNameInput.offsetWidth;
                profileNameInput.classList.add('error');
                
                profileNameInput.scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'center' 
                });
                
                setTimeout(() => {
                    profileNameInput.focus();
                    profileNameInput.select();
                }, 300);
                
                if (navigator.vibrate) {
                    navigator.vibrate([100, 50, 100]);
                }
                
                alert('A profile with this name already exists.');
                return false;
            }

            // Create profile via MongoDB API
            try {
                const response = await api.post('/api/profiles', {
                    name: profileName,
                    avatarUrl: avatarUrl
                });
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    if (errorData.error === 'limit') {
                        alert('You can only have up to 5 profiles.');
                    } else {
                        throw new Error('Failed to create profile');
                    }
                    return false;
                }
                
                // Reload profiles from MongoDB
                await loadProfilesFromAPI();
                closeAddProfileModal();
            } catch (error) {
                console.error('Failed to create profile:', error);
                alert('Failed to create profile. Please try again.');
            }
            
            return false;
        }

        function showEditProfileModal(profileId) {
            const profile = profiles.find(p => p.id === profileId);
            if (!profile) return;
            
            // Set profile data in the edit form
            document.getElementById('editProfileId').value = profileId;
            document.getElementById('editProfileName').value = profile.name;
            
            // Select the matching avatar
            const editAvatarOptions = document.querySelectorAll('#editAvatarSelection .avatar-option');
            editAvatarOptions.forEach(opt => opt.classList.remove('selected'));
            
            // Find and select the current avatar
            const currentAvatarMatch = editAvatarOptions[0]; // Default to first
            editAvatarOptions.forEach(opt => {
                const img = opt.querySelector('img');
                if (img && img.src === profile.avatarUrl) {
                    opt.classList.add('selected');
                } else if (profile.avatarUrl.includes(opt.dataset.avatar)) {
                    opt.classList.add('selected');
                }
            });
            
            // If no match found, select first
            if (!document.querySelector('#editAvatarSelection .avatar-option.selected')) {
                editAvatarOptions[0].classList.add('selected');
            }
            
            document.getElementById('editProfileModal').style.display = 'flex';
        }

        function closeEditProfileModal() {
            document.getElementById('editProfileModal').style.display = 'none';
            const editProfileNameInput = document.getElementById('editProfileName');
            editProfileNameInput.value = '';
            editProfileNameInput.classList.remove('error');
        }

        async function updateProfile(event) {
            event.preventDefault();
            
            const profileId = document.getElementById('editProfileId').value;
            const profileNameInput = document.getElementById('editProfileName');
            const profileName = profileNameInput.value.trim();
            
            // Get selected avatar data
            const selectedAvatarElement = document.querySelector('#editAvatarSelection .avatar-option.selected');
            const selectedAvatar = selectedAvatarElement.dataset.avatar;
            const selectedAvatarImg = selectedAvatarElement.querySelector('img');
            const avatarUrl = selectedAvatarImg ? selectedAvatarImg.src : `/assets/profile-avatars/${selectedAvatar}.png`;

            // Clear previous error styling
            profileNameInput.classList.remove('error');

            if (!profileName) {
                profileNameInput.classList.remove('error');
                void profileNameInput.offsetWidth;
                profileNameInput.classList.add('error');
                
                profileNameInput.scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'center' 
                });
                
                setTimeout(() => {
                    profileNameInput.focus();
                    profileNameInput.select();
                }, 300);
                
                if (navigator.vibrate) {
                    navigator.vibrate([200, 100, 200]);
                }
                
                return false;
            }

            // Check if profile name already exists (excluding current profile)
            if (profiles.some(profile => profile.id !== profileId && profile.name.toLowerCase() === profileName.toLowerCase())) {
                profileNameInput.classList.remove('error');
                void profileNameInput.offsetWidth;
                profileNameInput.classList.add('error');
                
                profileNameInput.scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'center' 
                });
                
                setTimeout(() => {
                    profileNameInput.focus();
                    profileNameInput.select();
                }, 300);
                
                if (navigator.vibrate) {
                    navigator.vibrate([100, 50, 100]);
                }
                
                alert('A profile with this name already exists.');
                return false;
            }

            // Update profile via MongoDB API
            try {
                const response = await api.put('/api/profiles/' + profileId, {
                    name: profileName,
                    avatarUrl: avatarUrl
                });
                
                if (!response.ok) {
                    throw new Error('Failed to update profile');
                }
                
                // Reload profiles from MongoDB
                await loadProfilesFromAPI();
                closeEditProfileModal();
            } catch (error) {
                console.error('Failed to update profile:', error);
                alert('Failed to update profile. Please try again.');
            }
            
            return false;
        }

        async function deleteProfile(profileId) {
            try {
                const response = await api.delete('/api/profiles/' + profileId);
                
                if (!response.ok) {
                    throw new Error('Failed to delete profile');
                }
                
                // Reload profiles from MongoDB
                await loadProfilesFromAPI();
            } catch (error) {
                console.error('Failed to delete profile:', error);
                alert('Failed to delete profile. Please try again.');
            }
        }

        function toggleManageMode() {
            manageMode = !manageMode;
            const btn = document.querySelector('.manage-profiles-btn');
            const profileCards = document.querySelectorAll('.profile-card:not(.add-profile-card)');
            const editButtons = document.querySelectorAll('.profile-edit-buttons');
            
            if (manageMode) {
                btn.textContent = 'Done';
                btn.classList.add('manage-active');
                profileCards.forEach(card => card.classList.add('manage-mode'));
                editButtons.forEach(btn => btn.style.display = 'flex');
            } else {
                btn.textContent = 'Manage Profiles';
                btn.classList.remove('manage-active');
                profileCards.forEach(card => card.classList.remove('manage-mode'));
                editButtons.forEach(btn => btn.style.display = 'none');
            }
        }

        function renderProfiles() {
            const grid = document.getElementById('profilesGrid');
            grid.innerHTML = '';

            // Render existing profiles
            profiles.forEach(profile => {
                const profileCard = document.createElement('div');
                profileCard.className = 'profile-card';
                profileCard.dataset.profileId = profile.id;
                
                const avatarUrl = profile.avatarUrl || '/images/avatar1.png';
                const initials = (profile.name || 'P').charAt(0).toUpperCase();
                
                profileCard.innerHTML = `
                    <div class="profile-avatar">
                        <img src="${avatarUrl}" alt="${profile.name}" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex'">
                        <div class="avatar-fallback">${initials}</div>
                    </div>
                    <p class="profile-name">${profile.name}</p>
                    <div class="profile-edit-buttons" style="display: none;">
                        <button class="edit-profile-btn" onclick="event.stopPropagation(); showEditProfileModal('${profile.id}')">‚úèÔ∏è</button>
                        <button class="delete-profile-btn" onclick="event.stopPropagation(); if(confirm('Delete this profile?')) deleteProfile('${profile.id}')">üóëÔ∏è</button>
                    </div>
                `;
                
                // Add click handler for selection
                profileCard.addEventListener('click', () => selectProfile(profile.id));
                
                grid.appendChild(profileCard);
            });

            // Show add profile button if less than 5 profiles
            if (profiles.length < 5) {
                const addProfileCard = document.createElement('div');
                addProfileCard.className = 'profile-card add-profile-card';
                addProfileCard.id = 'addProfileCard';
                addProfileCard.onclick = showAddProfileModal;
                
                addProfileCard.innerHTML = `
                    <div class="profile-avatar add-profile-avatar">
                        <span class="add-icon">+</span>
                    </div>
                    <p class="profile-name">Add Profile</p>
                `;
                
                grid.appendChild(addProfileCard);
            }
        }

        // Avatar selection functionality and initialization
        document.addEventListener('DOMContentLoaded', function() {
            // Load profiles from API
            loadProfilesFromAPI();
            
            // Avatar selection for add modal
            const avatarOptions = document.querySelectorAll('#addProfileModal .avatar-option');
            avatarOptions.forEach(option => {
                option.addEventListener('click', function() {
                    avatarOptions.forEach(opt => opt.classList.remove('selected'));
                    this.classList.add('selected');
                });
            });

            // Avatar selection for edit modal
            const editAvatarOptions = document.querySelectorAll('#editAvatarSelection .avatar-option');
            editAvatarOptions.forEach(option => {
                option.addEventListener('click', function() {
                    editAvatarOptions.forEach(opt => opt.classList.remove('selected'));
                    this.classList.add('selected');
                });
            });

            // Clear error styling when user starts typing in add modal
            const profileNameInput = document.getElementById('profileName');
            if (profileNameInput) {
                profileNameInput.addEventListener('input', function() {
                    this.classList.remove('error');
                });
            }

            // Clear error styling when user starts typing in edit modal
            const editProfileNameInput = document.getElementById('editProfileName');
            if (editProfileNameInput) {
                editProfileNameInput.addEventListener('input', function() {
                    this.classList.remove('error');
                });
            }
        });
    </script>
</body>
</html>
